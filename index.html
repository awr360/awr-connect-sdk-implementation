<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AWR Connect SDK – Documentation &amp; Implementation</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header class="site-header">
    <div class="container">
      <h1 class="logo">AWR Connect SDK</h1>
      <p class="tagline">Custom Channel client – documentation and example implementation</p>
    </div>
  </header>

  <nav class="nav-bar">
    <div class="container">
      <a href="#overview">Overview</a>
      <a href="#installation">Installation</a>
      <a href="#quick-start">Quick start</a>
      <a href="#media">Media upload &amp; display</a>
      <a href="#api">API reference</a>
      <a href="#types">Types</a>
      <a href="#events">Events</a>
      <a href="#auth">Authentication</a>
      <a href="#example">Live example</a>
    </div>
  </nav>

  <main class="main container">
    <section id="overview" class="doc-section">
      <h2>Overview</h2>
      <p>
        The <strong>AWR Connect Client JS SDK</strong> (<code>awr-client-js-sdk</code>) lets you connect your own UI to
        the AWR Connect chat platform via a <strong>Custom Channel</strong>. You use the channel’s connection key
        (<code>channelId</code>) and secret to send messages over REST and receive agent replies in real time over Socket.IO.
      </p>
      <ul>
        <li><strong>Real-time:</strong> Pass <code>sessionId</code> in config and call <code>connect()</code>; the SDK opens Socket.IO and joins a session room. Agent messages arrive via <code>message</code>.</li>
        <li><strong>REST:</strong> <code>sendMessage()</code> and <code>getConversation(sessionId, options)</code>; call <code>connect()</code> first.</li>
        <li><strong>Media:</strong> Use <code>uploadMedia(file, sessionId, mediaType)</code> to upload, then <code>sendMessage(caption, { sessionId, messageType: 'media', mediaUrl, mediaType })</code>. Incoming and history messages include pre-signed <code>mediaUrl</code> (no user-id required).</li>
        <li>Use a stable <code>sessionId</code> per visitor (must not contain <code>:</code>). <code>options.sessionId</code> is required on every <code>sendMessage()</code> and <code>uploadMedia()</code>.</li>
        <li>Obtain the connection key and secret when creating the Custom Channel in the webapp; the secret is shown only once.</li>
      </ul>
    </section>

    <section id="installation" class="doc-section">
      <h2>Installation</h2>
      <p>From your project root:</p>
      <pre class="code-block"><code>pnpm add awr-client-js-sdk</code></pre>
      <p>In the browser, you can load a built UMD bundle from your own build (e.g. from the
        <code>awr-connect-client-js-sdk</code> repo):
      </p>
      <pre
        class="code-block"><code>&lt;script src="path/to/awr-connect-client-js-sdk/dist/index.umd.js"&gt;&lt;/script&gt;</code></pre>
    </section>

    <section id="quick-start" class="doc-section">
      <h2>Quick start</h2>
      <p>Config uses <code>baseUrl</code>, <code>channelId</code>, and <code>secret</code>. For real-time receive, add <code>sessionId</code> (and optional <code>visitorName</code>). Register listeners before <code>connect()</code>. Send only after <code>connection_ready</code> fires (no payload). <code>getConversation(sessionId, options)</code> requires the client to be connected.</p>
      <pre class="code-block"><code>import { AwrConnectClient } from "awr-client-js-sdk";

const sessionId = "user-session-123";
const client = new AwrConnectClient({
  baseUrl: "https://your-api.example.com",
  channelId: "your-connection-key",
  secret: "your-channel-secret",
  sessionId,
  visitorName: "Alice",
});

client.on("connection_ready", () => {
  // Only then send or load history
});
client.on("connection_error", (err) => console.error(err));
client.on("message", (msg) => console.log("Agent:", msg.textMessage, msg.mediaUrl));
client.on("error", (err) => console.error(err));

client.connect();

// After connection_ready:
await client.sendMessage("Hello!", { sessionId, visitorName: "Alice" });
const { messages, pagination } = await client.getConversation(sessionId, { page: 1, limit: 20 });
client.disconnect();</code></pre>
    </section>

    <section id="media" class="doc-section">
      <h2>Media upload &amp; display</h2>
      <p><strong>Upload flow:</strong> Call <code>uploadMedia(file, sessionId, mediaType)</code> (requires <code>connect()</code> first). The API returns a <strong>pre-signed <code>mediaUrl</code></strong>. Then send it as a media message: <code>sendMessage(caption, { sessionId, messageType: 'media', mediaUrl, mediaType })</code>. Supported <code>mediaType</code>: <code>'image'</code>, <code>'audio'</code>, <code>'document'</code>.</p>
      <p><strong>Size limits:</strong> Image 10 MB, audio 16 MB, document 25 MB. Allowed types: common image/audio MIME types and PDF, DOC/DOCX, PPT/PPTX, XLS/XLSX, TXT.</p>
      <p><strong>Pre-signed URLs:</strong> Messages returned by <code>getConversation()</code> and real-time <code>message</code> events include <code>mediaUrl</code> that are already pre-signed and usable in the browser (images, audio, documents). The custom channel path does not require a user-id; links are generated with a fixed expiry.</p>
      <p><strong>Link lifetime:</strong> Upload and outbound media URLs expire in <strong>2 hours</strong>; history conversion uses <strong>1 hour</strong>. Use or cache URLs within that window.</p>
      <p><strong>Display:</strong> This example renders images inline (<code>&lt;img&gt;</code>), audio with <code>&lt;audio controls&gt;</code>, and documents as download links. Use <code>messageType</code> and <code>mediaType</code> to choose the right UI.</p>
    </section>

    <section id="api" class="doc-section">
      <h2>API reference</h2>
      <dl class="api-dl">
        <dt><code>constructor(config?: AwrConnectConfig)</code></dt>
        <dd>Create a client. Pass <code>baseUrl</code>, <code>channelId</code>, <code>secret</code>; optionally <code>sessionId</code>, <code>visitorName</code>, <code>requestId</code>.</dd>

        <dt><code>setConfig(config: AwrConnectConfig): void</code></dt>
        <dd>Set or update configuration.</dd>

        <dt><code>connect(config?: AwrConnectConfig): void</code></dt>
        <dd>Validate config and mark client connected. If <code>sessionId</code> is set, opens Socket.IO to <code>/custom</code> and joins the session room; <code>connection_ready</code> fires when the server acknowledges (no payload). 10s join timeout. Throws if <code>baseUrl</code>, <code>channelId</code>, or <code>secret</code> is missing.</dd>

        <dt><code>disconnect(): void</code></dt>
        <dd>Close Socket.IO (if open) and mark client disconnected.</dd>

        <dt><code>isConnected(): boolean</code></dt>
        <dd>Return whether the client is in a connected state.</dd>

        <dt><code>uploadMedia(file: File, sessionId: string, mediaType: 'image' | 'audio' | 'document'): Promise&lt;{ mediaUrl: string }&gt;</code></dt>
        <dd>Upload a file for the given <code>sessionId</code>. Requires client connected. Returns <code>{ mediaUrl }</code> (pre-signed, 2h expiry). Then call <code>sendMessage(caption, { sessionId, messageType: 'media', mediaUrl, mediaType })</code>. Subject to server rate limits (e.g. 30 uploads per minute per IP).</dd>

        <dt><code>sendMessage(textOrContent: string, options: SendMessageOptions): Promise&lt;{ success: boolean; message?: string }&gt;</code></dt>
        <dd>Send a text or media message. <strong><code>options.sessionId</code> is required</strong> (must not contain <code>:</code>). Options: <code>visitorName?</code>, <code>messageType?</code> ('TEXT' | 'media'), <code>mediaUrl?</code> (required when messageType is 'media'; use URL from <code>uploadMedia()</code>), <code>mediaType?</code> ('audio' | 'image' | 'video' | 'document'), <code>socialMessageId?</code>. For media, first arg is caption. Returns <code>{ success: true }</code> or <code>{ success: false, message }</code>; emits <code>error</code> on API failure. Throws if not connected or validation fails.</dd>

        <dt><code>getChannelInfo(): Promise&lt;ChannelInfoResponse&gt;</code></dt>
        <dd>GET channel details (secret not included). Requires client connected.</dd>

        <dt><code>getConversation(sessionId: string, options?: GetConversationOptions): Promise&lt;GetConversationResponse&gt;</code></dt>
        <dd>GET paginated messages for <code>sessionId</code>. <strong>Call <code>connect()</code> first.</strong> Options: <code>page?</code> (default 1), <code>limit?</code> (default 20). Returns <code>{ messages, pagination }</code>; <code>messages[].mediaUrl</code> are pre-signed and usable directly (e.g. images, audio, documents). Pagination has <code>currentPage</code>, <code>totalMessages</code>, <code>hasNextPage</code>, <code>nextPage</code>, etc. On 404 returns empty messages and default pagination (no throw).</dd>
      </dl>
    </section>

    <section id="types" class="doc-section">
      <h2>Types</h2>
      <pre class="code-block"><code>interface AwrConnectConfig {
  baseUrl: string;
  channelId: string;
  secret: string;
  sessionId?: string;   // required for real-time receive; must not contain ":"
  visitorName?: string;
  requestId?: string;   // sent as X-Request-Id
}

interface SendMessageOptions {
  sessionId: string;    // required; must not contain ":"
  visitorName?: string;
  messageType?: 'TEXT' | 'media';
  mediaUrl?: string;    // required when messageType is 'media'
  mediaType?: 'audio' | 'image' | 'video' | 'document';
  socialMessageId?: string | null;
}

interface GetConversationOptions {
  page?: number;
  limit?: number;
}

interface SimplifiedMessage {
  _id: string;
  senderType: 'CONTACT' | 'AGENT';
  messageType: string;
  textMessage?: string;
  mediaType?: string;
  mediaUrl?: string;    // pre-signed URL (2h or 1h expiry depending on context)
  status?: string;
  socialMessageId?: string | null;
  metadata?: Record&lt;string, unknown&gt;;
  createdAt?: string;
  updatedAt?: string;
}

interface Pagination {
  currentPage: number;
  limit: number;
  totalMessages: number;
  totalPages: number;
  hasNextPage: boolean;
  hasPrevPage: boolean;
  nextPage: number | null;
  prevPage: number | null;
}

interface GetConversationResponse {
  messages: SimplifiedMessage[];
  pagination: Pagination;
}

interface ChannelInfoResponse {
  id: number;
  name: string;
  channelUid: string;
  channelType: string;
  channelConfig: Record&lt;string, unknown&gt;;
}</code></pre>
    </section>

    <section id="events" class="doc-section">
      <h2>Events</h2>
      <p>The client extends EventEmitter. Subscribe with <code>client.on(eventName, handler)</code>. Attach listeners <strong>before</strong> calling <code>connect()</code>.</p>
      <ul>
        <li><code>connection_ready</code> – emitted when the Socket.IO join is acknowledged. <strong>No payload.</strong> Only after this should you send messages in real-time mode.</li>
        <li><code>connection_error</code> – emitted with an <code>Error</code> when connect or join fails (e.g. wrong secret, wrong channelId, sessionId contains <code>:</code>, or 10s timeout).</li>
        <li><code>error</code> – emitted with an <code>Error</code> on connection or request (send/getConversation) failures.</li>
        <li><code>message</code> – payload: <code>SimplifiedMessage</code>. Fired when an agent sends a message to this session (real-time). Check <code>messageType</code> ('text' or 'media') and <code>mediaType</code> / <code>mediaUrl</code> for media.</li>
      </ul>
    </section>

    <section id="auth" class="doc-section">
      <h2>Authentication &amp; security</h2>
      <p>All requests use the channel <strong>secret</strong> in the <code>X-AWR-Channel-Secret</code> header (or <code>Authorization: Bearer &lt;secret&gt;</code>). Get the connection key and secret when creating the Custom Channel in the AWR Connect webapp; the secret is shown only once and must be stored securely.</p>
      <p>Server-side: the API compares the secret using a <strong>timing-safe</strong> comparison to avoid leaking information. <strong>Media upload</strong> is rate-limited (e.g. 30 requests per minute per IP). Uploaded document filenames use an allowlisted extension from the validated MIME type, not the client filename.</p>
    </section>

    <section id="example" class="doc-section">
      <h2>Live example</h2>
      <p>Enter your Custom Channel <strong>id</strong> (Channel ID) and <strong>secret</strong>, then click <strong>Open
          chat</strong> to use the SDK in a real-time chat.</p>
      <p>Use the form below to try the SDK (or the same REST calls if the SDK is not loaded). Fill in your API base URL,
        channel ID (id), secret, and optionally session ID and visitor name. In the chat you can send text, or use
        <strong>Attach</strong> to upload an image, audio, or document (sent as a media message with a pre-signed URL).</p>
      <p class="note">The SDK is loaded from <code>unpkg</code> (see script below); media upload and pre-signed URLs require
        <code>awr-client-js-sdk@0.1.3</code> or later. This example reflects the current implementation: two-step media (upload then send), pre-signed media URLs in messages, rate-limited uploads, and timing-safe secret verification on the server.
      </p>

      <div class="example-panel">
        <!-- Credentials form: shown when not in chat -->
        <div id="credentials-wrap">
          <form id="config-form" class="example-form">
            <div class="form-row">
              <label for="baseUrl">Base URL</label>
              <input id="baseUrl" type="url" placeholder="https://your-api.example.com" value="" required />
            </div>
            <div class="form-row">
              <label for="channelId">Channel ID (id)</label>
              <input id="channelId" type="text" placeholder="your-custom-channel-id" value="" required />
            </div>
            <div class="form-row">
              <label for="secret">Secret</label>
              <input id="secret" type="password" placeholder="your-channel-secret" value="" required />
            </div>
            <div class="form-row">
              <label for="sessionId">Session ID</label>
              <input id="sessionId" type="text" placeholder="e.g. user-session-123 (optional)" value="" />
            </div>
            <div class="form-row">
              <label for="visitorName">Visitor name</label>
              <input id="visitorName" type="text" placeholder="e.g. Alice" value="" />
            </div>
            <div class="form-actions">
              <button type="button" id="btn-open-chat" class="btn-primary">Open chat</button>
              <button type="button" id="btn-connect">Connect</button>
              <button type="button" id="btn-send" disabled>Send message</button>
              <button type="button" id="btn-channel" disabled>Get channel info</button>
              <button type="button" id="btn-conversation" disabled>Get conversation</button>
              <button type="button" id="btn-disconnect" disabled>Disconnect</button>
            </div>
          </form>
          <div class="example-send-row">
            <label for="messageText">Message text</label>
            <input id="messageText" type="text" placeholder="Hello!" value="Hello from SDK docs" />
          </div>
          <div class="log-wrap">
            <h3>Log</h3>
            <pre id="log-output" class="log-output"></pre>
            <button type="button" id="btn-clear-log" class="btn-clear">Clear log</button>
          </div>
        </div>

        <!-- Chat panel: shown when in chat -->
        <div id="chat-panel" class="chat-panel" hidden>
          <div class="chat-header">
            <span id="chat-header-info" class="chat-header-info">Session · Visitor</span>
            <button type="button" id="btn-leave-chat" class="btn-leave-chat">Leave chat</button>
          </div>
          <div id="chat-error-banner" class="chat-error-banner" hidden></div>
          <div id="chat-messages" class="chat-messages"></div>
          <div class="chat-send-row">
            <input id="chat-file-input" type="file" accept="image/*,audio/*,.pdf,.doc,.docx,.txt,.xlsx,.pptx" hidden />
            <button type="button" id="btn-chat-attach" class="btn-chat-attach" title="Attach image, audio, or document">Attach</button>
            <input id="chat-input" type="text" placeholder="Type a message..." autocomplete="off" />
            <button type="button" id="btn-chat-send">Send</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>AWR Connect SDK documentation &amp; example implementation. See <code>awr-connect-client-js-sdk</code> for the
        package source and <code>TESTING.md</code> for testing against a running API.</p>
    </div>
  </footer>

  <script src="https://unpkg.com/awr-client-js-sdk@0.1.3/dist/index.umd.js"></script>
  <script src="app.js"></script>
</body>

</html>